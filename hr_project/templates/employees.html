{% extends 'base.html' %}
{% load humanize %}
{% block title %}Employees · Mega Coffee HR{% endblock %}
{% block nav_employees_active %}active{% endblock %}

{% block content %}
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
  }
  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideIn 0.3s;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .modal-header h2 {
    margin: 0;
  }
  .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
  }
  .form-group {
    margin-bottom: 1rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }
  .form-group input, .form-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
  }
  .editable-table {
    margin-bottom: 1rem;
  }
  .editable-table input {
    padding: 0.25rem 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  /* Settings modal - fullscreen style */
  #settingsModal .modal-content {
    max-width: 95%;
    max-height: 95vh;
    width: 1200px;
  }
  
  #settingsModal .modal-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 1rem;
  }
  
  #settingsModal .settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 1.5rem;
  }
  
  #settingsModal .settings-section {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  #settingsModal .settings-section h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 16px;
    font-weight: 600;
  }
</style>

<div class="card mt-20">
  <div class="card-header">
    <h2>Employee</h2>
    <div class="actions">
      <button class="btn primary" onclick="openSettingsModal()">⚙️ 직원 기본 설정</button>
      <a href="{% url 'employees:create' %}" class="btn primary">Add mate</a>
    </div>
  </div>
  <table class="table">
    <thead>
      <tr>
        <th>Employee Name</th><th>Shift</th><th>Age</th><th>Wage</th><th>Phone</th><th>Role</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for emp in employees %}
      <tr>
        <td>
          <div class="user">
            {% if emp.image %}
            <div class="avatar sm" style="background-image: url('{{ emp.image.url }}'); background-size: cover; background-position: center;"></div>
            {% else %}
            <div class="avatar sm"></div>
            {% endif %}
            <span>{{ emp.full_name }}</span>
            <span class="dot" style="background-color: {{ emp.color_tag }};"></span>
          </div>
        </td>
        <td>
          {% if '오픈' in emp.shift.name %}오픈{% elif '마감' in emp.shift.name %}마감{% elif '미들' in emp.shift.name %}미들{% endif %} | 
          {% if '월화수' in emp.shift.name %}월화수{% elif '목금' in emp.shift.name %}목금{% elif '토일' in emp.shift.name %}토일{% endif %} | 
          {{ emp.shift.time_range }}
        </td>
        <td>{{ emp.birth_year }}년생</td>
        <td>₩ {{ emp.wage|floatformat:0|intcomma }} ({{ emp.get_wage_type_display }})</td>
        <td class="phone-number">{{ emp.phone }}</td>
        <td>{{ emp.get_role_display }}</td>
        <td>
          <div style="display: flex; gap: 8px;">
            <a href="{% url 'employees:edit' emp.pk %}" class="btn" style="padding: 4px 12px; font-size: 14px;">수정</a>
            <form method="post" action="{% url 'employees:delete' emp.pk %}" style="display: inline;" onsubmit="return confirm('{{ emp.full_name }} 직원을 삭제하시겠습니까?');">
              {% csrf_token %}
              <button type="submit" class="btn" style="padding: 4px 12px; font-size: 14px; background: #ef4444; color: white;">삭제</button>
            </form>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" style="text-align: center; padding: 2rem; color: #888;">
          등록된 직원이 없습니다. "Add mate" 버튼을 눌러 직원을 추가하세요.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Settings Overview Modal (Full Screen) -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>⚙️ 직원 기본 설정</h2>
      <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
    </div>
    
    <div class="settings-grid">
      <!-- Role Setting Section -->
      <div class="settings-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>Default Role Setting</h3>
          <button class="btn" onclick="openRoleModal()">Edit</button>
        </div>
        <table class="table">
          <thead>
            <tr><th>Role</th><th>Base Wage</th><th>Type</th><th>Increase</th></tr>
          </thead>
          <tbody>
            {% for role in role_settings %}
            <tr>
              <td>{{ role.role }}</td>
              <td>₩ {{ role.base_wage|floatformat:0|intcomma }}</td>
              <td>{{ role.get_wage_type_display }}</td>
              <td>₩ {{ role.increase_per_6_month|floatformat:0|intcomma }}/6개월</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">설정된 역할이 없습니다.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Max Setting Section -->
      <div class="settings-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>Default Max Setting</h3>
          <button class="btn" onclick="openMaxModal()">Edit</button>
        </div>
        <table class="table">
          <thead>
            <tr><th>Max</th><th>Min</th></tr>
          </thead>
          <tbody>
            {% for max_setting in max_settings %}
            <tr>
              <td>₩ {{ max_setting.max_wage|floatformat:0|intcomma }}</td>
              <td>₩ {{ max_setting.min_wage|floatformat:0|intcomma }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="2">설정이 없습니다.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Hiring Setting Section -->
      <div class="settings-section" style="grid-column: span 2;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>Default Hiring Setting</h3>
          <button class="btn" onclick="openHiringModal()">Edit</button>
        </div>
        <table class="table">
          <thead>
            <tr><th>Type</th><th>Days</th><th>Time</th><th>Status</th></tr>
          </thead>
          <tbody>
            {% for group in hiring_slots %}
            <tr>
              <td>{{ group.type }}</td>
              <td>{{ group.days }}</td>
              <td>{{ group.time_range }}</td>
              <td>
                {% if group.representative_slot.status == 'open' %}
                <span class="badge gray">구인중</span>
                {% else %}
                <span class="badge green">구인완료</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="4">구인 슬롯이 없습니다.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Role Setting Modal -->
<div id="roleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>역할 설정 편집</h2>
      <button class="close-btn" onclick="closeModal('roleModal')">&times;</button>
    </div>
    <form method="post" action="{% url 'employees:list' %}">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_roles">
      <table class="table editable-table">
        <thead>
          <tr><th>역할</th><th>기본급여</th><th>유형</th><th>6개월당 인상</th></tr>
        </thead>
        <tbody>
          {% for role in role_settings %}
          <tr>
            <td>{{ role.role }}</td>
            <td><input type="number" name="base_wage_{{ role.id }}" value="{{ role.base_wage }}" required></td>
            <td>
              <select name="wage_type_{{ role.id }}">
                <option value="hourly" {% if role.wage_type == 'hourly' %}selected{% endif %}>시급</option>
                <option value="monthly" {% if role.wage_type == 'monthly' %}selected{% endif %}>월급</option>
              </select>
            </td>
            <tdSettingsModal() {
    document.getElementById('settingsModal').classList.add('active');
  }
  
  function openSettingsModal() {
    document.getElementById('settingsModal').classList.add('active');
  }
  
  function open><input type="number" name="increase_{{ role.id }}" value="{{ role.increase_per_6_month }}"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
        <button type="button" class="btn" onclick="closeModal('roleModal')">취소</button>
        <button type="submit" class="btn primary">저장</button>
      </div>
    </form>
  </div>
</div>

<!-- Max Setting Modal -->
<div id="maxModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>최대/최소 급여 설정</h2>
      <button class="close-btn" onclick="closeModal('maxModal')">&times;</button>
    </div>
    <form method="post" action="{% url 'employees:list' %}" id="maxSettingForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_max">
      {% for max_setting in max_settings %}
      <div class="form-group">
        <label>최저시급 기준 추가금액 (₩)</label>
        <input type="number" id="additional_wage" data-max-wage="{{ max_setting.max_wage }}" data-min-wage="{{ max_setting.min_wage }}" required>
        <small style="color: #666;" id="min_wage_text">최저시급 {{ max_setting.min_wage|floatformat:0|intcomma }}원 + 입력값</small>
      </div>
      <div style="padding: 0.75rem; background: #f0f9ff; border-radius: 6px; margin-bottom: 1rem;">
        <strong style="color: #0369a1;">계산된 최대 급여: ₩ <span id="calculated_max_wage">{{ max_setting.max_wage|floatformat:0|intcomma }}</span></strong>
      </div>
      <input type="hidden" name="max_wage" id="max_wage_hidden" value="{{ max_setting.max_wage }}">
      <div class="form-group">
        <label>최저 급여 (₩)</label>
        <input type="number" name="min_wage" id="min_wage_input" value="{{ max_setting.min_wage }}" required>
      </div>
      {% endfor %}
      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
        <button type="button" class="btn" onclick="closeModal('maxModal')">취소</button>
        <button type="submit" class="btn primary">저장</button>
      </div>
    </form>
  </div>
</div>

<!-- Hiring Setting Modal -->
<div id="hiringModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>구인 상태 편집</h2>
      <button class="close-btn" onclick="closeModal('hiringModal')">&times;</button>
    </div>
    <form method="post" action="{% url 'employees:list' %}">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_hiring">
      <table class="table editable-table" id="hiringTable">
        <thead>
          <tr><th>유형</th><th>요일</th><th>시간</th><th>상태</th><th>삭제</th></tr>
        </thead>
        <tbody>
          {% for group in hiring_slots %}
          <tr>
            <td>{{ group.type }}</td>
            <td>{{ group.days }}</td>
            <td>{{ group.time_range }}</td>
            <td>
              <select name="status_{{ group.representative_slot.id }}">
                <option value="open" {% if group.representative_slot.status == 'open' %}selected{% endif %}>구인중</option>
                <option value="filled" {% if group.representative_slot.status == 'filled' %}selected{% endif %}>구인완료</option>
              </select>
            </td>
            <td>
              <button type="button" class="btn" style="padding: 4px 8px; font-size: 12px; background: #ef4444; color: white;" onclick="deleteHiringSlot({{ group.representative_slot.id }}, '{{ group.representative_slot.shift.name }}')">X</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-bottom: 1rem;">
        <button type="button" class="btn" onclick="addNewHiringRow()" style="width: 100%;">➕ 새 구인 슬롯 추가</button>
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
        <button type="button" class="btn" onclick="closeModal('hiringModal')">취소</button>
        <button type="submit" class="btn primary">저장</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openSettingsModal() {
    document.getElementById('settingsModal').classList.add('active');
  }
  
  function openRoleModal() {
    document.getElementById('roleModal').classList.add('active');
  }
  
  function openMaxModal() {
    document.getElementById('maxModal').classList.add('active');
    
    const additionalInput = document.getElementById('additional_wage');
    const minWageInput = document.getElementById('min_wage_input');
    const maxWageHidden = document.getElementById('max_wage_hidden');
    const minWageText = document.getElementById('min_wage_text');
    const calculatedMaxWageDisplay = document.getElementById('calculated_max_wage');
    
    // 초기 추가금액 계산 및 설정
    const initialMaxWage = parseInt(additionalInput.dataset.maxWage) || 0;
    const initialMinWage = parseInt(additionalInput.dataset.minWage) || 0;
    additionalInput.value = initialMaxWage - initialMinWage;
    
    function updateMaxWage() {
      const minWage = parseInt(minWageInput.value) || 0;
      const additional = parseInt(additionalInput.value) || 0;
      const maxWage = minWage + additional;
      maxWageHidden.value = maxWage;
      
      // 화면에 표시되는 최대 급여 업데이트
      calculatedMaxWageDisplay.textContent = maxWage.toLocaleString('ko-KR');
    }
    
    function updateMinWageText() {
      const minWage = parseInt(minWageInput.value) || 0;
      const formattedMinWage = minWage.toLocaleString('ko-KR');
      minWageText.textContent = `최저시급 ${formattedMinWage}원 + 입력값`;
    }
    
    // 추가금액 입력 시 max_wage 계산
    if (additionalInput) {
      additionalInput.addEventListener('input', updateMaxWage);
    }
    
    // 최저 급여 입력 시 max_wage 계산 및 텍스트 업데이트
    if (minWageInput) {
      minWageInput.addEventListener('input', function() {
        updateMaxWage();
        updateMinWageText();
      });
    }
  }
  
  function openHiringModal() {
    document.getElementById('hiringModal').classList.add('active');
  }
  
  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
  }
  
  let newRowCounter = 0;
  
  function addNewHiringRow() {
    newRowCounter++;
    const tbody = document.querySelector('#hiringTable tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td>
        <select name="new_type_${newRowCounter}" required>
          <option value="">선택</option>
          <option value="오픈">오픈</option>
          <option value="마감">마감</option>
          <option value="미들">미들</option>
        </select>
      </td>
      <td>
        <select name="new_days_${newRowCounter}" required>
          <option value="">선택</option>
          <option value="월화수">월화수</option>
          <option value="목금">목금</option>
          <option value="토일">토일</option>
        </select>
      </td>
      <td>
        <input type="text" name="new_time_${newRowCounter}" placeholder="08:00-16:00" pattern="[0-9]{2}:[0-9]{2}-[0-9]{2}:[0-9]{2}" required>
      </td>
      <td>
        <select name="new_status_${newRowCounter}">
          <option value="open">구인중</option>
          <option value="filled">구인완료</option>
        </select>
      </td>
      <td>
        <button type="button" class="btn" style="padding: 4px 8px; font-size: 12px; background: #ef4444; color: white;" onclick="this.closest('tr').remove()">X</button>
      </td>
    `;
    tbody.appendChild(newRow);
  }
  
  function deleteHiringSlot(slotId, shiftName) {
    if (confirm(shiftName + ' 구인 슬롯을 삭제하시겠습니까?')) {
      // 폼을 동적으로 생성하여 제출
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '{% url "employees:list" %}';
      
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'delete_hiring';
      form.appendChild(actionInput);
      
      const slotInput = document.createElement('input');
      slotInput.type = 'hidden';
      slotInput.name = 'slot_id';
      slotInput.value = slotId;
      form.appendChild(slotInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  }
  
  // ESC 키로 모달 닫기 (hiringModal 제외)
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal').forEach(modal => {
        if (modal.id !== 'hiringModal') {
          modal.classList.remove('active');
        }
      });
    }
  });
  
  // 모달 배경 클릭 시 닫기 (hiringModal 제외)
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === modal && modal.id !== 'hiringModal') {
        modal.classList.remove('active');
      }
    });
  });
  
  // 전화번호 포매팅
  function formatPhoneNumber(phone) {
    const numbers = phone.replace(/[^\d]/g, '');
    if (numbers.length === 11) {
      return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7)}`;
    }
    return phone;
  }
  
  // 페이지 로드 시 모든 전화번호 포매팅
  document.querySelectorAll('.phone-number').forEach(cell => {
    cell.textContent = formatPhoneNumber(cell.textContent);
  });
</script>
{% endblock %}
