{% extends 'base.html' %}
{% load humanize %}

{% block title %}Attendance Â· Mega Coffee HR{% endblock %}
{% block nav_attendance_active %}active{% endblock %}

{% block content %}
<style>
    .dashboard-compact { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; }
    .stat-box { background: white; padding: 12px 24px; border-radius: 16px; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); height: 60px; flex: 1; }
    .stat-icon { width: 36px; height: 36px; border-radius: 10px; background: #fffbeb; color: #f59e0b; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .stat-text { display: flex; flex-direction: column; }
    .stat-label { font-size: 12px; color: #6b7280; font-weight: 500; }
    .stat-number { font-size: 18px; font-weight: 700; color: #111827; }
    .pos-btn-plump { background: #2563eb; color: white; text-decoration: none; padding: 0 24px; height: 60px; border-radius: 30px; display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 15px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transition: transform 0.2s, box-shadow 0.2s; border: none; white-space: nowrap; }
    .pos-btn-plump:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4); }

    .control-bar { 
        display: flex; justify-content: space-between; align-items: center; 
        background: white; padding: 16px 24px; border-radius: 16px; 
        border: 1px solid #e5e7eb; margin-bottom: 24px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
    }
    
    .date-display-area { display: flex; align-items: center; gap: 16px; }
    .current-date-text { font-size: 20px; font-weight: 800; color: #1f2937; }
    
    .nav-btn-group { display: flex; gap: 8px; }
    .date-btn { 
        background: white; border: 1px solid #d1d5db; width: 32px; height: 32px; 
        border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        color: #4b5563; transition: all 0.2s; 
    }
    .date-btn:hover { background: #f3f4f6; border-color: #9ca3af; }

    .picker-wrapper { position: relative; display: flex; align-items: center; }
    .date-input { 
        border: 1px solid #d1d5db; padding: 8px 12px; border-radius: 8px; 
        color: #374151; font-family: inherit; font-size: 14px; outline: none; cursor: pointer; 
        background: #fff;
    }
    .date-input:hover { border-color: #9ca3af; }

    .table-container { background: white; border-radius: 16px; border: 1px solid #e5e7eb; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .mc-table { width: 100%; border-collapse: collapse; text-align: left; }
    .mc-table th { background: #f9fafb; padding: 16px 24px; font-size: 13px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb; }
    .mc-table td { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; color: #374151; font-size: 15px; vertical-align: middle; }
    .mc-table tr:hover { background-color: #f9fafb; }
    .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .status-working { background: #dcfce7; color: #166534; }
    .status-absent { background: #fee2e2; color: #991b1b; }
    .status-finished { background: #f3f4f6; color: #4b5563; }
    .status-planned { background: #eff6ff; color: #1e40af; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;}
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal-overlay.active { display: flex; }
    .modal-box { background: white; width: 400px; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 24px; color: #1f2937; }
    .modal-field { margin-bottom: 20px; display: flex; flex-direction: column; }
    .modal-field label { font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px; }
    .modal-field input[type="time"] { border: 1px solid #d1d5db; border-radius: 10px; padding: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; }
    .modal-field input[type="time"]:focus { border-color: #2563eb; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    .btn-cancel { background: #f3f4f6; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; color: #4b5563; }
    .btn-save { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn-save:hover { background: #1d4ed8; }
    .edit-btn { padding: 6px 14px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151; transition: all 0.2s; }
    .edit-btn:hover { background: #f9fafb; border-color: #d1d5db; }
</style>

<div class="page-header" style="margin-bottom: 16px;">
    <h1 style="font-size: 24px; font-weight: 700; color: #1f2937; margin: 0;">ì¼ì¼ ê·¼íƒœ ê´€ë¦¬</h1>
</div>

<div class="dashboard-compact">
    <div class="stat-box">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-text">
            <span class="stat-label">ì˜¤ëŠ˜ ê·¼ë¬´ ëŒ€ìƒ</span>
            <span class="stat-number">{{ records|length }}ëª…</span>
        </div>
    </div>
    <a href="{% url 'attendances:checkin_and_out' %}" target="_blank" class="pos-btn-plump">
        <span>ğŸ“± POS í™”ë©´ ì—´ê¸°</span>
    </a>
</div>

<div class="control-bar">
    <div class="date-display-area">
        <div class="nav-btn-group">
            <button type="button" class="date-btn" onclick="changeDate(-1)"> â® </button>
            <span class="current-date-text"> {{ filter_date|date:"Yë…„ mì›” dì¼" }} </span>
            <button type="button" class="date-btn" onclick="changeDate(1)"> â¯ </button>
        </div>
    </div>
    
    <div class="picker-wrapper">
        <input type="date" id="datePicker" class="date-input" value="{{ filter_date|date:'Y-m-d' }}" onchange="window.location.href='?date='+this.value">
    </div>
</div>

<div class="table-container">
    <table class="mc-table">
        <thead>
            <tr>
                <th width="15%">ì§ì› ì´ë¦„</th>
                <th width="12%">ì¶œê·¼ ì‹œê°</th>
                <th width="12%">í‡´ê·¼ ì‹œê°</th>
                <th width="12%">ê·¼ë¬´ í˜„í™©</th>
                <th width="12%">íœ´ê²Œ ì—¬ë¶€</th>
                <th width="12%">ëŒ€íƒ€ ì—¬ë¶€</th>
                <th width="15%">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for item in records %}
            <tr>
                <td>
                    <div class="user-info">
                        <div class="user-avatar" style="background-color: {{ item.employee.color_tag }};">
                            {{ item.employee.full_name|slice:":1" }}
                        </div>
                        <span style="font-weight: 600; color: #374151;">{{ item.employee.full_name }}</span>
                    </div>
                </td>
                <td>
                    {% if item.check_in %}
                        <span style="font-weight: 600;">{{ item.check_in|time:"H:i" }}</span>
                    {% else %}
                        <span style="color: #9ca3af;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.check_out %}
                        <span style="font-weight: 600; color: #6b7280;">{{ item.check_out|time:"H:i" }}</span>
                    {% else %}
                        <span style="color: #9ca3af;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.status == 'working' %}
                        <span class="status-badge status-working"><span class="dot"></span>ê·¼ë¬´ ì¤‘</span>
                    {% elif item.status == 'finished' %}
                        <span class="status-badge status-finished">í‡´ê·¼</span>
                    {% elif item.status == 'absent' %}
                        <span class="status-badge status-absent"><span class="dot"></span>ê²°ê·¼</span>
                    {% else %}
                        <span class="status-badge status-planned">ê·¼ë¬´ ì˜ˆì •</span>
                    {% endif %}
                </td>
                
                <td>
                    {% if item.employee.is_break %}
                        <span style="color: #2563eb; font-weight: 600; font-size: 13px;">ì ìš© (30ë¶„)</span>
                    {% else %}
                        <span style="color: #9ca3af; font-size: 13px;">ì—†ìŒ</span>
                    {% endif %}
                </td>

                <td>
                    {% if item.is_substitute %}
                        <span style="background: #fffbeb; color: #b45309; font-size: 12px; padding: 2px 6px; border-radius: 4px; border: 1px solid #fcd34d;">ëŒ€íƒ€ ê·¼ë¬´</span>
                    {% else %}
                        <span style="color: #d1d5db;">-</span>
                    {% endif %}
                </td>
                <td>
                    <button class="edit-btn" 
                        onclick="openModal(
                            '{{ item.employee.id }}', 
                            '{{ filter_date|date:'Y-m-d' }}', 
                            '{{ item.check_in|date:'H:i' }}', 
                            '{{ item.check_out|date:'H:i' }}'
                        )">
                        âœï¸ ì‹œê°„ ìˆ˜ì •
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 60px 0; color: #9ca3af;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“…</div>
                    í•´ë‹¹ ë‚ ì§œì— ê·¼ë¬´ ì˜ˆì •ìë‚˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-title">ê·¼íƒœ ê¸°ë¡ ìˆ˜ì •</div>
        
        <form method="POST" action="{% url 'attendances:update' %}">
            {% csrf_token %}
            <input type="hidden" name="employee_id" id="modalEmployeeId">
            <input type="hidden" name="date" id="modalDate">

            <div class="modal-field">
                <label>ì¶œê·¼ ì‹œê°</label>
                <input type="time" name="check_in" id="modalCheckIn">
            </div>

            <div class="modal-field">
                <label>í‡´ê·¼ ì‹œê°</label>
                <input type="time" name="check_out" id="modalCheckOut">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn-save">ì €ì¥í•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<script>
    function changeDate(days) {
        const dateInput = document.getElementById('datePicker');
        if (!dateInput.value) return;
        const currentDate = new Date(dateInput.value);
        currentDate.setDate(currentDate.getDate() + days);
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        window.location.href = '?date=' + `${year}-${month}-${day}`;
    }

    function openModal(empId, dateStr, checkIn, checkOut) {
        const modal = document.getElementById("editModal");
        modal.classList.add('active');
        document.getElementById("modalEmployeeId").value = empId;
        document.getElementById("modalDate").value = dateStr;
        document.getElementById("modalCheckIn").value = checkIn || "";
        document.getElementById("modalCheckOut").value = checkOut || "";
    }

    function closeModal() {
        document.getElementById("editModal").classList.remove('active');
    }

    document.getElementById("editModal").addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}