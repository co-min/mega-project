{% extends 'base.html' %}
{% block topbar_search %}{% endblock %}
{% load static %}
{% load humanize %}

{% block content %}
<style>
    /* ------------------------------------------------
       헤더 스타일
    ------------------------------------------------ */
    .cal-header-standalone {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px; /* 캘린더와의 간격 */
        padding: 0 4px;      /* 양옆 살짝 여유 */
    }

    /* 네비게이션 버튼 */
    .btn-nav {
        width: 36px; height: 36px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* 입체감 살짝 추가 */
    }
    .btn-nav:hover { background: #f9fafb; border-color: #9ca3af; }

    .current-month-text {
        font-size: 26px; /* 밖으로 나왔으니 조금 더 키움 */
        font-weight: 800;
        color: #111827;
        padding: 0 16px;
        font-family: 'Pretendard', sans-serif;
    }

    /* 오른쪽 컨트롤 */
    .cal-controls { display: flex; align-items: center; gap: 12px; }

    .quick-wage-zone {
        display: flex; align-items: center; gap: 8px;
        background: white; /* 배경 흰색으로 명확하게 */
        padding: 8px 16px;
        border-radius: 8px; 
        border: 1px solid #d1d5db;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .wage-display { font-weight: 700; color: #2563eb; font-size: 15px; }
    .mc-select-slim {
        border: none; outline: none; font-size: 13px; font-weight: 600;
        cursor: pointer; background: transparent; color: #4b5563;
    }

    /* ------------------------------------------------
       2. 캘린더 컨테이너 (그리드만 포함)
    ------------------------------------------------ */
    .calendar-container {
        background-color: #ffffff;
        border-radius: 16px;
        padding: 0; /* 패딩 제거 (그리드가 꽉 차게) */
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        border: 1px solid #d1d5db;
        overflow: hidden; /* 모서리 둥글게 유지 */
    }

    /* ------------------------------------------------
       3. 그리드 레이아웃
    ------------------------------------------------ */
    .cal-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        border-bottom: 1px solid #d1d5db;
        background: #f9fafb; /* 요일 헤더 배경색 추가 (구분감) */
        padding: 12px 0;
        margin-bottom: 0;
    }
    
    .weekday { 
        font-size: 14px; font-weight: 700; color: #4b5563; 
        font-family: 'Pretendard', sans-serif;
    }

    .cal-grid {
        display: flex; flex-direction: column;
        background-color: white;
    }
    .cal-row { display: grid; grid-template-columns: repeat(7, 1fr); }
    
    .cal-cell {
        min-height: 140px; 
        height: auto;
        padding: 8px;
        border-right: 1px solid #e5e7eb; /* 선 색상 약간 연하게 조정 */
        border-bottom: 1px solid #e5e7eb;
        display: flex; flex-direction: column; gap: 4px;
        position: relative;
    }
    .cal-cell:nth-child(7n) { border-right: none; } /* 마지막 칸 오른쪽 선 제거 */

    .cal-cell.empty { background: #fffbeb; }

    .day-num {
        font-size: 15px; font-weight: 600; color: #1f2937;
        margin-bottom: 6px; padding-left: 2px;
        font-family: 'Pretendard', sans-serif;
    }
    .cal-cell:nth-child(7n+1) .day-num { color: #dc2626; }
    .cal-cell:nth-child(7n) .day-num { color: #2563eb; }

    /* ------------------------------------------------
       4. 스케줄 카드 & 버튼
    ------------------------------------------------ */
    .sch-card {
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 12px;
        display: flex; flex-direction: column;
        position: relative;
        line-height: 1.3;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        margin-bottom: 2px;
        background: white; /* 기본 배경 */
    }
    .sch-hidden { display: none; }

    .sch-header { display: flex; align-items: center; font-weight: 600; }
    .emp-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
    .sch-time { font-size: 11px; opacity: 0.9; margin-left: 12px; font-weight: 500; }

    /* 상태별 스타일 */
    .status-planned { background: #f9fafb; color: #6b7280; border: 1px dashed #d1d5db; }
    .status-working { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
    .status-finished { background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
    .status-absent { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .is-substitute { background: #fffbeb !important; border: 1px solid #fcd34d !important; color: #92400e !important; }
    .badge-sub { position: absolute; top: -4px; right: -4px; background: #f59e0b; color: white; font-size: 9px; padding: 1px 4px; border-radius: 99px; font-weight: 700; }

    .btn-more {
        margin-top: auto;
        background: white;
        border: 1px solid #e5e7eb;
        width: 100%;
        padding: 5px 0;
        border-radius: 4px;
        color: #6b7280;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-more:hover { background: #f9fafb; color: #111827; border-color: #d1d5db; }
</style>

<div class="cal-header-standalone">
    <div style="display:flex; align-items:center; gap:12px;">
        <button class="btn-nav" onclick="location.href='?year={{ prev_year }}&month={{ prev_month }}'">❮</button>
        <div class="current-month-text">{{ year }}년 {{ month }}월</div>
        <button class="btn-nav" onclick="location.href='?year={{ next_year }}&month={{ next_month }}'">❯</button>
    </div>

    <div class="cal-controls">
        <div class="quick-wage-zone">
            <select id="liveEmpSelect" onchange="calcLive()" class="mc-select-slim">
                <option value="">급여 확인 (직원 선택)</option>
                {% for emp in employees %}
                <option value="{{ emp.id }}" data-wage="{{ emp.hourly_wage|default:9860 }}">
                    {{ emp.full_name }}
                </option>
                {% endfor %}
            </select>
            <span id="liveResult" class="wage-display"></span>
        </div>

        <input type="month" value="{{ year }}-{{ month|stringformat:'02d' }}" onchange="moveDate(this.value)" 
               style="padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; font-size:14px; cursor:pointer; outline:none; color: #374151; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
    </div>
</div>

<div class="calendar-container">
    <div class="cal-weekdays">
        <div class="weekday" style="color:#dc2626">SUN</div>
        <div class="weekday">MON</div>
        <div class="weekday">TUE</div>
        <div class="weekday">WED</div>
        <div class="weekday">THU</div>
        <div class="weekday">FRI</div>
        <div class="weekday" style="color:#2563eb">SAT</div>
    </div>

    <div class="cal-grid">
        {% for week in calendar_matrix %}
        <div class="cal-row">
            {% for date_info in week %}
                {% if date_info.day == 0 %}
                    <div class="cal-cell empty"></div>
                {% else %}
                    <div class="cal-cell">
                        <span class="day-num">{{ date_info.day }}</span>
                        
                        {% for item in date_info.schedules %}
                            <div class="sch-card 
                                {% if forloop.counter > 2 %}sch-hidden{% endif %}
                                {% if item.is_substitute %}is-substitute{% endif %}
                                {% if item.status == 'planned' %}status-planned
                                {% elif item.status == 'working' %}status-working
                                {% elif item.status == 'finished' %}status-finished
                                {% elif item.status == 'absent' %}status-absent
                                {% endif %}
                            " 
                            data-emp-id="{{ item.employee_id }}" 
                            data-hours="{{ item.work_hours|default:0 }}">
                                
                                {% if item.is_substitute %}
                                    <span class="badge-sub">대타</span>
                                {% endif %}

                                <div class="sch-header">
                                    <span class="emp-dot" style="background-color: {{ item.color|default:'#9ca3af' }};"></span>
                                    <span>{{ item.name }}</span>
                                </div>
                                {% if item.time %}
                                    <span class="sch-time">{{ item.time }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}

                        {% if date_info.schedules|length > 2 %}
                            <button class="btn-more" onclick="toggleSchedule(this)">
                                + {{ date_info.schedules|length|add:"-2" }}명 더보기
                            </button>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function moveDate(value) {
        if (!value) return;
        const [y, m] = value.split('-');
        window.location.href = `?year=${y}&month=${parseInt(m)}`;
    }

    function toggleSchedule(btn) {
        const cell = btn.closest('.cal-cell');
        const hiddenItems = cell.querySelectorAll('.sch-card.sch-hidden');
        
        if (hiddenItems.length > 0) {
            hiddenItems.forEach(item => {
                item.classList.remove('sch-hidden');
                item.classList.add('sch-expanded');
            });
            btn.innerText = "접기 ▲";
        } else {
            const expandedItems = cell.querySelectorAll('.sch-card.sch-expanded');
            expandedItems.forEach(item => {
                item.classList.remove('sch-expanded');
                item.classList.add('sch-hidden');
            });
            const totalCards = cell.querySelectorAll('.sch-card').length;
            const hiddenCount = totalCards - 2;
            btn.innerText = `+ ${hiddenCount}명 더보기`;
        }
    }

    function calcLive() {
        const sel = document.getElementById('liveEmpSelect');
        const empId = sel.value;
        const wage = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-wage'));
        const res = document.getElementById('liveResult');

        if (!empId) { res.innerText = ""; return; }

        let hours = 0;
        document.querySelectorAll(`.sch-card[data-emp-id="${empId}"]`).forEach(card => {
            if (!card.classList.contains('status-absent')) {
                hours += parseFloat(card.getAttribute('data-hours') || 0);
            }
        });

        const totalPay = Math.floor(hours * wage);
        res.innerText = `₩${totalPay.toLocaleString()}`;
    }
</script>
{% endblock %}